<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能报销系统技术架构</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
    --layer-0-bg: #f1f5f9;
    --layer-0-border: #94a3b8;
    --layer-0-title: #475569;
    --layer-0-service-bg: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    --layer-0-service-border: #64748b;
    --layer-0-service-text: #334155;
    --layer-0-service-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
    --layer-1-bg: #f1f5f9;
    --layer-1-border: #94a3b8;
    --layer-1-title: #475569;
    --layer-1-service-bg: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    --layer-1-service-border: #64748b;
    --layer-1-service-text: #334155;
    --layer-1-service-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
    --layer-2-bg: #f1f5f9;
    --layer-2-border: #94a3b8;
    --layer-2-title: #475569;
    --layer-2-service-bg: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    --layer-2-service-border: #64748b;
    --layer-2-service-text: #334155;
    --layer-2-service-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
    --layer-3-bg: #f1f5f9;
    --layer-3-border: #94a3b8;
    --layer-3-title: #475569;
    --layer-3-service-bg: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    --layer-3-service-border: #64748b;
    --layer-3-service-text: #334155;
    --layer-3-service-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
    --left-panel-bg: #f3f4f6;
    --left-panel-border: #9ca3af;
    --left-panel-title: #374151;
    --left-block-bg: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
    --left-block-border: #6b7280;
    --left-block-text: #374151;
    --left-block-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
    --right-panel-bg: #ecfeff;
    --right-panel-border: #67e8f9;
    --right-panel-title: #164e63;
    --right-block-bg: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%);
    --right-block-border: #0891b2;
    --right-block-text: #164e63;
    --right-block-shadow: 0 2px 8px rgba(103, 232, 249, 0.2);
    --side-panel-bg: #f3f4f6;
    --side-panel-border: #9ca3af;
    --side-panel-title: #374151;
    --side-block-bg: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
    --side-block-border: #6b7280;
    --side-block-text: #374151;
    --side-block-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
} /* Jinja2 injected CSS variables */

        .architecture-container {
            max-width: 1000px; /* Jinja2 specific */
        }

        .architecture-grid {
            grid-template-columns: 20% 60% 20%; /* Jinja2 specific */
        }

        /* Dynamic layer styles */
        
        .layer-0 {
            background: var(--layer-0-bg);
            border-color: var(--layer-0-border);
        }
        .layer-0 .layer-title {
                           border-bottom-color: var(--layer-0-border);
                           color: var(--layer-0-title);
                       }
        .layer-0 .service-box {
                           background: var(--layer-0-service-bg);
                           border-color: var(--layer-0-service-border);
                           color: var(--layer-0-service-text);
                           box-shadow: var(--layer-0-service-shadow);
                       }
        
        .layer-1 {
            background: var(--layer-1-bg);
            border-color: var(--layer-1-border);
        }
        .layer-1 .layer-title {
                           border-bottom-color: var(--layer-1-border);
                           color: var(--layer-1-title);
                       }
        .layer-1 .service-box {
                           background: var(--layer-1-service-bg);
                           border-color: var(--layer-1-service-border);
                           color: var(--layer-1-service-text);
                           box-shadow: var(--layer-1-service-shadow);
                       }
        
        .layer-2 {
            background: var(--layer-2-bg);
            border-color: var(--layer-2-border);
        }
        .layer-2 .layer-title {
                           border-bottom-color: var(--layer-2-border);
                           color: var(--layer-2-title);
                       }
        .layer-2 .service-box {
                           background: var(--layer-2-service-bg);
                           border-color: var(--layer-2-service-border);
                           color: var(--layer-2-service-text);
                           box-shadow: var(--layer-2-service-shadow);
                       }
        
        .layer-3 {
            background: var(--layer-3-bg);
            border-color: var(--layer-3-border);
        }
        .layer-3 .layer-title {
                           border-bottom-color: var(--layer-3-border);
                           color: var(--layer-3-title);
                       }
        .layer-3 .service-box {
                           background: var(--layer-3-service-bg);
                           border-color: var(--layer-3-service-border);
                           color: var(--layer-3-service-text);
                           box-shadow: var(--layer-3-service-shadow);
                       }
        
        
        /* 箭头样式 - 添加过渡动画 */
        .arrow-up {
            display: flex;
            justify-content: center;
            margin: 0.2rem 0;
            transition: all 0.3s ease;
        }

        .arrow-up svg {
            width: 1.1rem;
            height: 1.1rem;
            color: #94a3b8;
            display: block;
            filter: drop-shadow(0 1px 2px rgba(148, 163, 184, 0.2));
            transition: all 0.3s ease;
        }

        /* 紧凑布局时的层级样式 */
        .architecture-layer {
            background: var(--layer-bg, white); /* 使用CSS变量，white作为fallback */
            transition: all 0.3s ease;
            border: 2px solid var(--layer-border, #e2e8f0); /* 使用CSS变量设置边框色 */
        }

        /* 层级特定样式 - 支持独立主题 */
        .layer-0 {
            background: var(--layer-0-bg, white);
            border-color: var(--layer-0-border, #e2e8f0);
        }

        .layer-1 {
            background: var(--layer-1-bg, white);
            border-color: var(--layer-1-border, #e2e8f0);
        }

        .layer-2 {
            background: var(--layer-2-bg, white);
            border-color: var(--layer-2-border, #e2e8f0);
        }

        .layer-3 {
            background: var(--layer-3-bg, white);
            border-color: var(--layer-3-border, #e2e8f0);
        }

        .layer-4 {
            background: var(--layer-4-bg, white);
            border-color: var(--layer-4-border, #e2e8f0);
        }

        .layer-5 {
            background: var(--layer-5-bg, white);
            border-color: var(--layer-5-border, #e2e8f0);
        }

        /* 连接线隐藏时的紧凑样式 */
        .connections-hidden .architecture-layer {
            margin-bottom: 0.5rem !important;
        }

        .connections-hidden .arrow-up {
            margin: 0;
            height: 0;
            overflow: hidden;
        }

        /* 小尺寸主题按钮样式 */
        .layer-theme-preset, .panel-theme-preset {
            width: 24px !important;
            height: 24px !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 0.6rem !important;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            margin: 1px !important;
        }

        .layer-theme-preset:hover, .panel-theme-preset:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            border-color: #3b82f6 !important;
        }

        .layer-theme-preset.active, .panel-theme-preset.active {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
            transform: scale(1.05) !important;
        }

        /* 小主题选择器网格 */
        .layer-theme-presets .theme-preset-grid, 
        .panel-theme-presets .theme-preset-grid {
            display: grid !important;
            grid-template-columns: repeat(6, 1fr) !important;
            gap: 2px !important;
            margin-top: 4px !important;
        }

        /* 内嵌CSS */
        body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 70%);
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 1rem;
    position: relative;
}

.controls-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    border: 1px solid #e2e8f0;
    backdrop-filter: blur(20px);
    max-width: 300px;
    max-height: 85vh;
    overflow-y: auto;
}

.controls-section {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e2e8f0;
}

.controls-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.controls-section h3 {
    margin: 0 0 12px 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.control-group {
    margin-bottom: 12px;
}

.control-group label {
    display: block;
    font-size: 0.75rem;
    color: #64748b;
    margin-bottom: 4px;
    font-weight: 500;
}

.control-group input, .control-group select {
    width: 100%;
    height: 32px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 0 10px;
    font-size: 0.8rem;
    background: rgba(255, 255, 255, 0.9);
    transition: all 0.2s ease;
}

.control-group input:focus, .control-group select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.toggle-btn {
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
    font-weight: 500;
}

.toggle-btn:hover {
    background: #059669;
}

.toggle-btn.disabled {
    background: #ef4444;
}

.toggle-btn.disabled:hover {
    background: #dc2626;
}

.color-input {
    height: 40px !important;
    padding: 4px !important;
    cursor: pointer;
}

.theme-preset-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 8px;
}

.theme-preset {
    width: 100%;
    height: 32px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.7rem;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
}

.theme-preset:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.theme-preset.active {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

.layer-color-controls, .side-panel-color-controls {
    background: #f8fafc;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid #e2e8f0;
}

.layer-color-controls h4, .side-panel-color-controls h4 {
    margin: 0 0 8px 0;
    font-size: 0.8rem;
    color: #374151;
    font-weight: 600;
}

.color-row {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
    align-items: center;
}

.color-row label {
    flex: 1;
    margin: 0;
    font-size: 0.7rem;
}

.color-row input[type="color"] {
    width: 40px;
    height: 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 0;
}

.reset-btn {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s ease;
    width: 100%;
    font-weight: 500;
}

.reset-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.download-btn {
    display: none; /* 完全隐藏按钮 */
}

/* 或者显示为禁用状态 */
.download-btn {
    background: #f3f4f6 !important;
    color: #9ca3af !important;
    cursor: not-allowed !important;
    opacity: 0.5;
}

.download-btn:hover {
    background: #f3f4f6 !important;
}

.download-btn.jpeg {
    background: #10b981;
}

.download-btn.jpeg:hover {
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.architecture-container {
    /* max-width is set dynamically via inline style in HTML */
    background: linear-gradient(125deg, rgba(248, 250, 252, 0.9) 50%, rgba(241, 245, 249, 0.9) 100%);
    border-radius: 1.25rem;
    box-shadow:
            0 0 0 4px rgba(255, 255, 255, 0.8),
            0 4px 24px 0 rgba(100, 116, 139, 0.08),
            0 0 0 1px rgba(148, 163, 184, 0.2);
    border: 3px solid transparent;
    background-clip: padding-box;
    position: relative;
    padding: 1rem;
    transition: all 0.3s ease;
    resize: none;
    overflow: auto;
    min-width: 600px;
    min-height: 400px;
}

.architecture-grid {
    display: grid;
    /* grid-template-columns is set dynamically via inline style in HTML */
    gap: 1rem;
    height: 100%;
    align-items: stretch;
}

/* 单列模式 */
.single-column .architecture-grid {
    grid-template-columns: 1fr !important; /* Override dynamic inline style if single column class is present */
}

/* 侧面板样式 */
.side-panel {
    background: var(--side-panel-bg);
    border: 2px solid var(--side-panel-border);
    border-radius: 1rem;
    padding: 1rem;
    height: 100%; /* Ensure panels stretch */
    min-height: 300px; /* Keep min-height for cases where grid itself is small */
    display: flex; /* Use flexbox for internal alignment */
    flex-direction: column; /* Align items vertically */
    justify-content: space-between; /* Distribute space when content is less */
}

/* 左侧面板特定样式 */
#left-panel {
    background: var(--left-panel-bg);
    border: 2px solid var(--left-panel-border);
}

#left-panel .side-panel-title {
    color: var(--left-panel-title);
    border-bottom: 2px solid var(--left-panel-border);
    flex-shrink: 0; /* Prevent title from shrinking */
}

#left-panel .side-block {
    background: var(--left-block-bg);
    border: 1.5px solid var(--left-block-border);
    box-shadow: var(--left-block-shadow);
}

#left-panel .side-block:hover {
    box-shadow: var(--left-block-shadow), 0 4px 12px rgba(0, 0, 0, 0.1);
}

#left-panel .side-block-title {
    color: var(--left-block-text);
}

#left-panel .side-block-item {
    border: 1px solid var(--left-block-border);
    color: var(--left-block-text);
}

/* 右侧面板特定样式 */
#right-panel {
    background: var(--right-panel-bg);
    border: 2px solid var(--right-panel-border);
}

#right-panel .side-panel-title {
    color: var(--right-panel-title);
    border-bottom: 2px solid var(--right-panel-border);
    flex-shrink: 0; /* Prevent title from shrinking */
}

#right-panel .side-block {
    background: var(--right-block-bg);
    border: 1.5px solid var(--right-block-border);
    box-shadow: var(--right-block-shadow);
}

#right-panel .side-block:hover {
    box-shadow: var(--right-block-shadow), 0 4px 12px rgba(0, 0, 0, 0.1);
}

#right-panel .side-block-title {
    color: var(--right-block-text);
}

#right-panel .side-block-item {
    border: 1px solid var(--right-block-border);
    color: var(--right-block-text);
}

.side-panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--side-panel-title);
    margin-bottom: 1rem;
    text-align: center;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--side-panel-border);
    flex-shrink: 0;
}

.side-panel-blocks-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    justify-content: space-around;
}

.side-block {
    background: var(--side-block-bg);
    border: 1.5px solid var(--side-block-border);
    border-radius: 0.75rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    box-shadow: var(--side-block-shadow);
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
}

.side-block:last-child {
    margin-bottom: 0;
}

.side-block-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--side-block-text);
    margin-bottom: 0.5rem;
    flex-shrink: 0;
}

.side-block-content {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    gap: 0.4rem;
    flex-grow: 1;
    justify-content: space-around;
}

.side-block-item {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid var(--side-block-border);
    border-radius: 0.4rem;
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
    color: var(--side-block-text);
    white-space: nowrap;
    transition: all 0.2s ease;
}

.side-block-item:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(1.05);
}

/* 中间层级区域 */
.center-layers {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    height: 100%;
}

.architecture-layer {
    background: var(--layer-bg, white); /* 使用CSS变量，white作为fallback */
    border-radius: 0.75rem;
    padding: 0.75rem;
    margin: 0 0 1rem 0; /* 默认间距 */
    box-shadow: 0 2px 8px 0 rgba(100, 116, 139, 0.05);
    transition: all 0.3s ease; /* 添加过渡动画，包括margin */
    border: 2px solid var(--layer-border, #e2e8f0); /* 使用CSS变量设置边框色 */
    position: relative;
    overflow: hidden;
}

/* 层级特定样式 - 支持独立主题 */
.layer-0 {
    background: var(--layer-0-bg, white);
    border-color: var(--layer-0-border, #e2e8f0);
}

.layer-1 {
    background: var(--layer-1-bg, white);
    border-color: var(--layer-1-border, #e2e8f0);
}

.layer-2 {
    background: var(--layer-2-bg, white);
    border-color: var(--layer-2-border, #e2e8f0);
}

.layer-3 {
    background: var(--layer-3-bg, white);
    border-color: var(--layer-3-border, #e2e8f0);
}

.layer-4 {
    background: var(--layer-4-bg, white);
    border-color: var(--layer-4-border, #e2e8f0);
}

.layer-5 {
    background: var(--layer-5-bg, white);
    border-color: var(--layer-5-border, #e2e8f0);
}

.architecture-layer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.03;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent 50%);
    pointer-events: none;
}

.architecture-layer:hover {
    transform: translateY(-2px) scale(1.005);
    box-shadow: 0 4px 12px 0 rgba(100, 116, 139, 0.08);
}

.layer-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-align: center;
    padding: 0.3rem 0;
    border-bottom: 2px solid; /* Border color set by dynamic styles */
    letter-spacing: 0.015em;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.4rem 0.4rem 0 0;
    /* Color set by dynamic styles */
}

.service-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 0.5rem;
}

.service-box {
    border-radius: 0.5rem;
    padding: 0.4rem 0.7rem;
    text-align: center;
    font-size: 0.82rem;
    font-weight: 500;
    flex: 1 1 calc(33% - 0.5rem);
    min-width: 100px;
    transition: all 0.25s ease;
    border: 1.5px solid; /* Border color set by dynamic styles */
    position: relative;
    letter-spacing: 0.01em;
    /* Background, color, box-shadow set by dynamic styles */
}

.service-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent 50%);
    border-radius: inherit;
    pointer-events: none;
}

.service-box:hover {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 4px 12px rgba(100, 116, 139, 0.15); /* This might be overridden by dynamic styles */
}

/* 箭头样式 - 添加过渡动画 */
.arrow-up {
    display: flex;
    justify-content: center;
    margin: 0.2rem 0;
    transition: all 0.3s ease; /* 添加过渡动画 */
}

.arrow-up svg {
    width: 1.1rem;
    height: 1.1rem;
    color: #94a3b8;
    display: block;
    filter: drop-shadow(0 1px 2px rgba(148, 163, 184, 0.2));
    transition: all 0.3s ease; /* 添加过渡动画 */
}

/* 连接线容器 - 添加过渡动画 */
.connections-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    transition: all 0.3s ease; /* 添加过渡动画 */
}

.connection-line {
    stroke: #94a3b8;
    stroke-width: 2;
    fill: none;
    marker-end: url(#arrowhead);
    opacity: 0.7;
    transition: all 0.3s ease;
}

.connection-line:hover {
    stroke: #64748b;
    stroke-width: 3;
    opacity: 1;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .controls-panel {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 1rem;
        width: 100%;
        max-width: none;
        max-height: none;
        overflow-y: visible;
    }

    .architecture-container {
        padding: 0.5rem;
        resize: none;
        width: 100%;
        max-width: 100% !important; /* Ensure override for small screens */
        min-width: auto;
    }

    .architecture-grid {
        grid-template-columns: 1fr !important;
        gap: 0.5rem;
    }

    .side-panel,
    .center-layers {
        height: auto;
        min-height: auto;
    }

    .side-panel {
        order: 3;
    }

    .center-layers {
        order: 2;
    }

    .service-box {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 80px;
        font-size: 0.78rem;
        padding: 0.35rem 0.55rem;
    }

    .layer-title { font-size: 0.95rem; }
}

@media (max-width: 500px) {
    .service-box {
        flex: 1 1 100%;
        font-size: 0.72rem;
        padding: 0.3rem 0.45rem;
        min-width: 0;
    }

    .side-block-content {
        flex-direction: column;
    }

    .side-block-item {
        text-align: center;
    }
}

/* 单列模式 specific styles for center content */
.single-column .center-layers {
    /* Ensure it behaves like a block */
}

.single-column .service-group {
    justify-content: flex-start;
}

.single-column .service-box {
    flex-basis: auto;
    min-width: 120px;
}

/* 连接线隐藏时的紧凑样式 */
.connections-hidden .architecture-layer {
    margin-bottom: 0.5rem !important; /* 强制紧凑间距 */
}

/* 小尺寸主题按钮样式 */
.layer-theme-preset, .panel-theme-preset {
    width: 24px !important;
    height: 24px !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 0.6rem !important;
    color: white !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    margin: 1px !important;
}

.layer-theme-preset:hover, .panel-theme-preset:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
    border-color: #3b82f6 !important;
}

.layer-theme-preset.active, .panel-theme-preset.active {
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
    transform: scale(1.05) !important;
}

/* 小主题选择器网格 */
.layer-theme-presets .theme-preset-grid, 
.panel-theme-presets .theme-preset-grid {
    display: grid !important;
    grid-template-columns: repeat(6, 1fr) !important;
    gap: 2px !important;
    margin-top: 4px !important;
}

    </style>
</head>
<body>
<div class="controls-panel">
    <div class="controls-section">
        <h3>布局控制</h3>

        
        <div class="control-group">
            <label>左侧面板</label>
            <button class="toggle-btn" id="left-panel-toggle"
                    onclick="togglePanel('left')"
                    data-enabled="true">
                启用
            </button>
        </div>

        <div class="control-group">
            <label>右侧面板</label>
            <button class="toggle-btn" id="right-panel-toggle"
                    onclick="togglePanel('right')"
                    data-enabled="true">
                启用
            </button>
        </div>
        

        <div class="control-group">
            <label for="width-input">容器宽度 (px)</label>
            <input type="number" id="width-input" min="600" max="1400" value="1000" />
        </div>

        <div class="control-group">
            <label for="scale-input">缩放 (%)</label>
            <input type="number" id="scale-input" min="50" max="150" value="100" step="5" />
        </div>

        
        
        <div class="control-group">
            <label for="left-width-input">左侧面板宽度 (px)</label>
            <input type="number" id="left-width-input" min="200" max="400" value="200" step="10" />
        </div>
        

        
        <div class="control-group">
            <label for="right-width-input">右侧面板宽度 (px)</label>
            <input type="number" id="right-width-input" min="200" max="400" value="200" step="10" />
        </div>
        
        
    </div>

    <div class="controls-section">
        <h3>连接线</h3>
        <div class="control-group">
            <button class="toggle-btn" id="connections-toggle"
                    onclick="toggleConnections()"
                    data-enabled="true">
                显示
            </button>
        </div>
    </div>

    <!-- 可选：添加禁用提示 -->
    <div class="controls-section">
        <h3>导出下载</h3>
        <div class="control-group">
            <div style="padding: 10px; background: #f3f4f6; border-radius: 4px; color: #6b7280; font-size: 14px;">
                ⚠️ 下载功能已被管理员禁用
            </div>
        </div>
    </div>

    <div class="controls-section">
        <h3>预设主题</h3>
        <div class="theme-preset-grid">
            <button class="theme-preset" data-theme="blue" style="background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%)">蓝色</button>
            <button class="theme-preset" data-theme="green" style="background: linear-gradient(135deg, #a7d4a7 0%, #86bc86 100%)">绿色</button>
            <button class="theme-preset" data-theme="purple" style="background: linear-gradient(135deg, #c7b8e0 0%, #b4a5d6 100%)">紫色</button>
            <button class="theme-preset" data-theme="yellow" style="background: linear-gradient(135deg, #e8d5a3 0%, #d4c590 100%)">黄色</button>
            <button class="theme-preset" data-theme="red" style="background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%)">红色</button>
            <button class="theme-preset" data-theme="cyan" style="background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%)">青色</button>
            <button class="theme-preset" data-theme="orange" style="background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%)">橙色</button>
            <button class="theme-preset" data-theme="pink" style="background: linear-gradient(135deg, #f9a8d4 0%, #f472b6 100%)">粉色</button>
            <button class="theme-preset" data-theme="gray" style="background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%)">灰色</button>
            <button class="theme-preset" data-theme="indigo" style="background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)">靛蓝</button>
        </div>
    </div>

    <div class="controls-section">
        <h3>颜色自定义</h3>
        <div id="layer-color-controls">
        </div>
        
        <div id="side-panel-color-controls">
        </div>
        
        <button class="reset-btn" onclick="resetAllColors()">重置所有颜色</button>
    </div>
</div>

<div class="architecture-container " id="architecture-container">
    <div class="architecture-grid" id="architecture-grid">

        
        <div class="side-panel" id="left-panel">
            <h2 class="side-panel-title">基础设施</h2>
            <div class="side-panel-blocks-container">
                
                <div class="side-block">
                    <div class="side-block-title">计算资源</div>
                    <div class="side-block-content">
                        
                        <div class="side-block-item">Kubernetes集群</div>
                        
                        <div class="side-block-item">Docker容器</div>
                        
                        <div class="side-block-item">Serverless</div>
                        
                    </div>
                </div>
                
                <div class="side-block">
                    <div class="side-block-title">网络与安全</div>
                    <div class="side-block-content">
                        
                        <div class="side-block-item">VPC网络</div>
                        
                        <div class="side-block-item">负载均衡</div>
                        
                        <div class="side-block-item">WAF防火墙</div>
                        
                    </div>
                </div>
                
            </div>
        </div>
        

        <div class="center-layers">
            
            
            

            
            <div class="architecture-layer layer-0" data-layer-index="0" id="layer-layer_4">
                <h2 class="layer-title">4、数据层</h2>
                
                
                
                <div class="service-group database-group">
                    
                    <div class="service-box">结构化数据(MySQL)</div>
                    
                    <div class="service-box">文档数据(MongoDB)</div>
                    
                    <div class="service-box">缓存(Redis)</div>
                    
                </div>
                
                <div class="service-group database-group">
                    
                    <div class="service-box">文件存储(MinIO)</div>
                    
                    <div class="service-box">消息队列(Kafka)</div>
                    
                    <div class="service-box">数据仓库(ClickHouse)</div>
                    
                </div>
                
                
            </div>
            
            <div class="arrow-up">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                </svg>
            </div>
            
            
            <div class="architecture-layer layer-1" data-layer-index="1" id="layer-layer_3">
                <h2 class="layer-title">3、AI能力层</h2>
                
                
                
                <div class="service-group default-group">
                    
                    <div class="service-box">OCR识别服务</div>
                    
                    <div class="service-box">NLP处理服务</div>
                    
                    <div class="service-box">模型推理服务</div>
                    
                    <div class="service-box">规则引擎服务</div>
                    
                    <div class="service-box">数据标注平台</div>
                    
                </div>
                
                
            </div>
            
            <div class="arrow-up">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                </svg>
            </div>
            
            
            <div class="architecture-layer layer-2" data-layer-index="2" id="layer-layer_2">
                <h2 class="layer-title">2、应用服务层</h2>
                
                
                
                <div class="service-group default-group">
                    
                    <div class="service-box">报销单管理</div>
                    
                    <div class="service-box">审批工作流引擎</div>
                    
                    <div class="service-box">合规校验服务</div>
                    
                </div>
                
                <div class="service-group default-group">
                    
                    <div class="service-box">风险控制服务</div>
                    
                    <div class="service-box">报表分析服务</div>
                    
                    <div class="service-box">审计日志服务</div>
                    
                </div>
                
                
            </div>
            
            <div class="arrow-up">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                </svg>
            </div>
            
            
            <div class="architecture-layer layer-3" data-layer-index="3" id="layer-layer_1">
                <h2 class="layer-title">1、用户/外部系统层</h2>
                
                
                
                <div class="service-group default-group">
                    
                    <div class="service-box">员工报销门户(Web/App)</div>
                    
                    <div class="service-box">财务管理系统</div>
                    
                    <div class="service-box">第三方支付平台</div>
                    
                    <div class="service-box">企业ERP系统</div>
                    
                </div>
                
                
            </div>
            
            
        </div>

        
        <div class="side-panel" id="right-panel">
            <h2 class="side-panel-title">开发运维</h2>
            <div class="side-panel-blocks-container">
                
                <div class="side-block">
                    <div class="side-block-title">CI/CD</div>
                    <div class="side-block-content">
                        
                        <div class="side-block-item">GitLab CI</div>
                        
                        <div class="side-block-item">Jenkins</div>
                        
                        <div class="side-block-item">ArgoCD</div>
                        
                    </div>
                </div>
                
                <div class="side-block">
                    <div class="side-block-title">监控告警</div>
                    <div class="side-block-content">
                        
                        <div class="side-block-item">Prometheus</div>
                        
                        <div class="side-block-item">Grafana</div>
                        
                        <div class="side-block-item">ELK</div>
                        
                    </div>
                </div>
                
                <div class="side-block">
                    <div class="side-block-title">API管理</div>
                    <div class="side-block-content">
                        
                        <div class="side-block-item">Kong网关</div>
                        
                        <div class="side-block-item">Swagger UI</div>
                        
                        <div class="side-block-item">API版本控制</div>
                        
                    </div>
                </div>
                
            </div>
        </div>
        

    </div>
</div>

<!-- 连接线SVG -->

<svg id="connections-svg" class="connections-overlay" xmlns="http://www.w3.org/2000/svg" style="display: block;">
    
    <g class="connection-group" data-from="layer_1" data-to="layer_2">
        <line class="connection-line" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
        
        <text class="connection-label" fill="#64748b" font-size="12" text-anchor="middle">API调用</text>
        
    </g>
    
    <g class="connection-group" data-from="layer_2" data-to="layer_3">
        <line class="connection-line" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
        
        <text class="connection-label" fill="#64748b" font-size="12" text-anchor="middle">AI服务调用</text>
        
    </g>
    
    <g class="connection-group" data-from="layer_3" data-to="layer_4">
        <line class="connection-line" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
        
        <text class="connection-label" fill="#64748b" font-size="12" text-anchor="middle">数据存取</text>
        
    </g>
    
    <g class="connection-group" data-from="left-panel" data-to="layer_4">
        <line class="connection-line" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
        
        <text class="connection-label" fill="#64748b" font-size="12" text-anchor="middle">资源供给</text>
        
    </g>
    
    <g class="connection-group" data-from="right-panel" data-to="layer_2">
        <line class="connection-line" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
        
        <text class="connection-label" fill="#64748b" font-size="12" text-anchor="middle">运维管理</text>
        
    </g>
    
</svg>


<script>
    // 内嵌JavaScript
    // 主题配色数据 (Static, can be in external JS)
const themeColors = {
    blue: {
        layerBg: "#f1f5f9",
        border: "#94a3b8",
        title: "#475569",
        serviceBg: "linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%)",
        serviceBorder: "#64748b",
        serviceText: "#334155",
        serviceShadow: "0 2px 8px rgba(148, 163, 184, 0.2)"
    },
    green: {
        layerBg: "#f0fdf4",
        border: "#86bc86",
        title: "#4a5a4a",
        serviceBg: "linear-gradient(135deg, #a7d4a7 0%, #86bc86 100%)",
        serviceBorder: "#6b9b6b",
        serviceText: "#2d4a2d",
        serviceShadow: "0 2px 8px rgba(134, 188, 134, 0.2)"
    },
    purple: {
        layerBg: "#f4f1ff",
        border: "#b4a5d6",
        title: "#5a4d6b",
        serviceBg: "linear-gradient(135deg, #c7b8e0 0%, #b4a5d6 100%)",
        serviceBorder: "#9a89b8",
        serviceText: "#4a3d5a",
        serviceShadow: "0 2px 8px rgba(180, 165, 214, 0.2)"
    },
    yellow: {
        layerBg: "#fefce8",
        border: "#d4c590",
        title: "#6b5a2d",
        serviceBg: "linear-gradient(135deg, #e8d5a3 0%, #d4c590 100%)",
        serviceBorder: "#b8a676",
        serviceText: "#5a4d2d",
        serviceShadow: "0 2px 8px rgba(212, 197, 144, 0.2)"
    },
    red: {
        layerBg: "#fef2f2",
        border: "#f87171",
        title: "#7f1d1d",
        serviceBg: "linear-gradient(135deg, #fca5a5 0%, #f87171 100%)",
        serviceBorder: "#dc2626",
        serviceText: "#7f1d1d",
        serviceShadow: "0 2px 8px rgba(248, 113, 113, 0.2)"
    },
    cyan: {
        layerBg: "#ecfeff",
        border: "#67e8f9",
        title: "#164e63",
        serviceBg: "linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%)",
        serviceBorder: "#0891b2",
        serviceText: "#164e63",
        serviceShadow: "0 2px 8px rgba(103, 232, 249, 0.2)"
    },
    orange: {
        layerBg: "#fef3c7",
        border: "#fb923c",
        title: "#9a3412",
        serviceBg: "linear-gradient(135deg, #fdba74 0%, #fb923c 100%)",
        serviceBorder: "#ea580c",
        serviceText: "#9a3412",
        serviceShadow: "0 2px 8px rgba(251, 146, 60, 0.2)"
    },
    pink: {
        layerBg: "#fce7f3",
        border: "#f472b6",
        title: "#831843",
        serviceBg: "linear-gradient(135deg, #f9a8d4 0%, #f472b6 100%)",
        serviceBorder: "#db2777",
        serviceText: "#831843",
        serviceShadow: "0 2px 8px rgba(244, 114, 182, 0.2)"
    },
    gray: {
        layerBg: "#f3f4f6",
        border: "#9ca3af",
        title: "#374151",
        serviceBg: "linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%)",
        serviceBorder: "#6b7280",
        serviceText: "#374151",
        serviceShadow: "0 2px 8px rgba(156, 163, 175, 0.2)"
    },
    indigo: {
        layerBg: "#e0f2fe",
        border: "#60a5fa",
        title: "#1e3a8a",
        serviceBg: "linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%)",
        serviceBorder: "#2563eb",
        serviceText: "#1e3a8a",
        serviceShadow: "0 2px 8px rgba(96, 165, 250, 0.2)"
    }
};

// currentState, leftPanelConfigured, rightPanelConfigured are defined in an inline script in template.html

// 切换侧面板显示
function togglePanel(side) {
    const panel = document.getElementById(`${side}-panel`);
    const toggle = document.getElementById(`${side}-panel-toggle`);

    if (side === 'left') {
        currentState.leftPanelEnabled = !currentState.leftPanelEnabled;
        if (toggle) {
            toggle.textContent = currentState.leftPanelEnabled ? '启用' : '禁用';
            toggle.classList.toggle('disabled', !currentState.leftPanelEnabled);
        }
        if (panel) {
            panel.style.display = currentState.leftPanelEnabled ? 'flex' : 'none'; // Use flex for side panels
        }
    } else {
        currentState.rightPanelEnabled = !currentState.rightPanelEnabled;
        if (toggle) {
            toggle.textContent = currentState.rightPanelEnabled ? '启用' : '禁用';
            toggle.classList.toggle('disabled', !currentState.rightPanelEnabled);
        }
        if (panel) {
            panel.style.display = currentState.rightPanelEnabled ? 'flex' : 'none'; // Use flex for side panels
        }
    }
    generateSidePanelColorControls(); // Regenerate if visibility changes
    updateSidePanelColorInputs();
    updateGridLayout();
    saveColorSettings(); // Save panel state
}

// 更新网格布局
function updateGridLayout() {
    const grid = document.getElementById('architecture-grid');
    const container = document.getElementById('architecture-container');
    if (!grid || !container) return;

    let columnStyles = [];

    const leftWidthInput = document.getElementById('left-width-input');
    const rightWidthInput = document.getElementById('right-width-input');

    // Use currentState for panel widths, fallback to input value or default
    let leftPanelWidth = currentState.leftPanelWidth;
    if (leftWidthInput && currentState.leftPanelEnabled) {
        leftPanelWidth = parseInt(leftWidthInput.value) || currentState.leftPanelWidth;
        currentState.leftPanelWidth = leftPanelWidth; // Update state from input if enabled
    }

    let rightPanelWidth = currentState.rightPanelWidth;
    if (rightWidthInput && currentState.rightPanelEnabled) {
        rightPanelWidth = parseInt(rightWidthInput.value) || currentState.rightPanelWidth;
        currentState.rightPanelWidth = rightPanelWidth; // Update state from input if enabled
    }

    const centerMinWidth = 300; // Adjusted minimum width for center

    let activeColumns = 0;
    if (leftPanelConfigured && currentState.leftPanelEnabled) activeColumns++;
    if (rightPanelConfigured && currentState.rightPanelEnabled) activeColumns++;
    activeColumns++; // For center column

    if (leftPanelConfigured && currentState.leftPanelEnabled) {
        columnStyles.push(leftPanelWidth + 'px');
    }

    columnStyles.push(`minmax(${centerMinWidth}px, 1fr)`);


    if (rightPanelConfigured && currentState.rightPanelEnabled) {
        columnStyles.push(rightPanelWidth + 'px');
    }

    if (columnStyles.length === 1 && columnStyles[0] === `minmax(${centerMinWidth}px, 1fr)`) {
        container.classList.add('single-column');
        grid.style.gridTemplateColumns = '1fr';
    } else {
        container.classList.remove('single-column');
        grid.style.gridTemplateColumns = columnStyles.join(' ');
    }
}

// 切换连接线显示（最终优化版本）
function toggleConnections() {
    const toggle = document.getElementById('connections-toggle');
    const svg = document.getElementById('connections-svg');
    const arrows = document.querySelectorAll('.arrow-up');
    const container = document.getElementById('architecture-container');

    currentState.connectionsVisible = !currentState.connectionsVisible;
    
    if (toggle) {
        toggle.textContent = currentState.connectionsVisible ? '隐藏' : '显示';
        toggle.classList.toggle('disabled', !currentState.connectionsVisible);
    }
    
    // 控制SVG连接线
    if (svg) {
        svg.style.display = currentState.connectionsVisible ? 'block' : 'none';
    }
    
    // 控制HTML箭头
    arrows.forEach(arrow => {
        arrow.style.display = currentState.connectionsVisible ? 'flex' : 'none';
    });
    
    // 通过CSS类控制整体布局紧凑性
    if (container) {
        if (currentState.connectionsVisible) {
            container.classList.remove('connections-hidden');
        } else {
            container.classList.add('connections-hidden');
        }
    }
    
    saveColorSettings(); // Save connection visibility
}

// 应用最大宽度限制和缩放
function applyResize() {
    const container = document.getElementById('architecture-container');
    const widthInput = document.getElementById('width-input');
    const scaleInput = document.getElementById('scale-input');
    if (!container) return;

    const width = widthInput ? widthInput.value : currentState.containerWidth;
    const scale = scaleInput ? scaleInput.value / 100 : currentState.scale / 100;

    if (width) {
        container.style.maxWidth = width + 'px';
        currentState.containerWidth = parseInt(width);
    }

    container.style.transform = `scale(${scale})`;
    container.style.transformOrigin = 'top center'; // Changed to top center for better scaling effect
    currentState.scale = parseInt(scaleInput ? scaleInput.value : currentState.scale);

    saveColorSettings(); // Save width and scale
}

// 初始化事件监听
function initializeEventListeners() {
    const widthInput = document.getElementById('width-input');
    const scaleInput = document.getElementById('scale-input');
    const leftWidthInput = document.getElementById('left-width-input');
    const rightWidthInput = document.getElementById('right-width-input');

    if (widthInput) widthInput.addEventListener('input', applyResize);
    if (scaleInput) scaleInput.addEventListener('input', applyResize);

    if (leftWidthInput) {
        leftWidthInput.addEventListener('input', () => {
            currentState.leftPanelWidth = parseInt(leftWidthInput.value);
            updateGridLayout();
            saveColorSettings();
        });
    }
    if (rightWidthInput) {
        rightWidthInput.addEventListener('input', () => {
            currentState.rightPanelWidth = parseInt(rightWidthInput.value);
            updateGridLayout();
            saveColorSettings();
        });
    }

    const leftToggle = document.getElementById('left-panel-toggle');
    const rightToggle = document.getElementById('right-panel-toggle');
    const connectionsToggle = document.getElementById('connections-toggle');

    if (leftToggle) {
        leftToggle.textContent = currentState.leftPanelEnabled ? '启用' : '禁用';
        leftToggle.classList.toggle('disabled', !currentState.leftPanelEnabled);
        const leftPanel = document.getElementById('left-panel');
        if (leftPanel) leftPanel.style.display = currentState.leftPanelEnabled ? 'flex' : 'none';
    }
    if (rightToggle) {
        rightToggle.textContent = currentState.rightPanelEnabled ? '启用' : '禁用';
        rightToggle.classList.toggle('disabled', !currentState.rightPanelEnabled);
        const rightPanel = document.getElementById('right-panel');
        if (rightPanel) rightPanel.style.display = currentState.rightPanelEnabled ? 'flex' : 'none';
    }
    if (connectionsToggle) {
        connectionsToggle.textContent = currentState.connectionsVisible ? '隐藏' : '显示';
        connectionsToggle.classList.toggle('disabled', !currentState.connectionsVisible);
        
        // 初始化时同时控制SVG和HTML箭头
        const svg = document.getElementById('connections-svg');
        const arrows = document.querySelectorAll('.arrow-up');
        const container = document.getElementById('architecture-container');
        
        if (svg) svg.style.display = currentState.connectionsVisible ? 'block' : 'none';
        arrows.forEach(arrow => {
            arrow.style.display = currentState.connectionsVisible ? 'flex' : 'none';
        });
        
        // 初始化容器CSS类
        if (container) {
            if (currentState.connectionsVisible) {
                container.classList.remove('connections-hidden');
            } else {
                container.classList.add('connections-hidden');
            }
        }
    }
}

// 颜色处理函数
function hexToRgba(hex, alpha = 1) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function adjustBrightness(hex, percent) {
    const num = parseInt(hex.slice(1), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.min(255, Math.max(0, (num >> 16) + amt));
    const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
    const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
}

// 生成层级颜色控制器
function generateLayerColorControls() {
    const layerColorControlsContainer = document.getElementById('layer-color-controls');
    if (!layerColorControlsContainer) return;

    layerColorControlsContainer.innerHTML = ''; // Clear previous controls
    const layers = document.querySelectorAll('.architecture-layer');

    layers.forEach((layer, index) => {
        const layerTitleElement = layer.querySelector('.layer-title');
        const titleText = layerTitleElement ? layerTitleElement.textContent.split('、').slice(1).join('、').trim() : `Layer ${index + 1}`;

        const controlDiv = document.createElement('div');
        controlDiv.className = 'layer-color-controls'; // This class is for the sub-section for each layer
        controlDiv.innerHTML = `
                <h4>${titleText} (第${index + 1}层)</h4>
                
                <!-- 层级专用主题选择器 -->
                <div class="layer-theme-presets" style="margin-bottom: 12px;">
                    <label style="font-size: 0.7rem; color: #64748b; margin-bottom: 4px; display: block;">快速主题</label>
                    <div class="theme-preset-grid">
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="blue" style="background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">蓝</button>
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="green" style="background: linear-gradient(135deg, #a7d4a7 0%, #86bc86 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">绿</button>
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="purple" style="background: linear-gradient(135deg, #c7b8e0 0%, #b4a5d6 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">紫</button>
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="yellow" style="background: linear-gradient(135deg, #e8d5a3 0%, #d4c590 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">黄</button>
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="red" style="background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">红</button>
                        <button class="layer-theme-preset" data-layer="${index}" data-theme="cyan" style="background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">青</button>
                    </div>
                </div>
                
                <!-- 详细颜色控制 -->
                <div class="color-row">
                    <label>背景色</label>
                    <input type="color" id="layer-${index}-bg" value="#f1f5f9" data-type="layer" data-index="${index}" data-property="bg">
                </div>
                <div class="color-row">
                    <label>边框色</label>
                    <input type="color" id="layer-${index}-border" value="#94a3b8" data-type="layer" data-index="${index}" data-property="border">
                </div>
                <div class="color-row">
                    <label>标题色</label>
                    <input type="color" id="layer-${index}-title" value="#475569" data-type="layer" data-index="${index}" data-property="title">
                </div>
                <div class="color-row">
                    <label>服务块</label>
                    <input type="color" id="layer-${index}-service" value="#94a3b8" data-type="layer" data-index="${index}" data-property="service">
                </div>
            `;
        layerColorControlsContainer.appendChild(controlDiv);
    });

    // 添加事件监听器给颜色输入框
    const colorInputs = layerColorControlsContainer.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        input.addEventListener('input', handleColorChange);
    });

    // 添加事件监听器给层级主题按钮
    const layerThemeButtons = layerColorControlsContainer.querySelectorAll('.layer-theme-preset');
    layerThemeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const layerIndex = e.target.dataset.layer;
            const themeName = e.target.dataset.theme;
            applyThemeToLayer(parseInt(layerIndex), themeName);
            
            // 更新按钮状态
            const layerButtons = layerColorControlsContainer.querySelectorAll(`[data-layer="${layerIndex}"]`);
            layerButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            saveColorSettings();
        });
    });
}

// 生成侧面板颜色控制器
function generateSidePanelColorControls() {
    const sidePanelColorControlsContainer = document.getElementById('side-panel-color-controls');
    if (!sidePanelColorControlsContainer) return;

    sidePanelColorControlsContainer.innerHTML = ''; // Clear previous controls
    const panelsInfo = [
        { id: 'left-panel', name: '左侧面板', prefix: 'left', enabled: currentState.leftPanelEnabled && leftPanelConfigured },
        { id: 'right-panel', name: '右侧面板', prefix: 'right', enabled: currentState.rightPanelEnabled && rightPanelConfigured }
    ];

    panelsInfo.forEach(panelInfo => {
        if (panelInfo.enabled) {
            const controlDiv = document.createElement('div');
            controlDiv.className = 'side-panel-color-controls'; // This class is for the sub-section for each side panel
            controlDiv.innerHTML = `
                    <h4>${panelInfo.name}</h4>
                    
                    <!-- 侧面板专用主题选择器 -->
                    <div class="panel-theme-presets" style="margin-bottom: 12px;">
                        <label style="font-size: 0.7rem; color: #64748b; margin-bottom: 4px; display: block;">快速主题</label>
                        <div class="theme-preset-grid">
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="blue" style="background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">蓝</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="green" style="background: linear-gradient(135deg, #a7d4a7 0%, #86bc86 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">绿</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="purple" style="background: linear-gradient(135deg, #c7b8e0 0%, #b4a5d6 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">紫</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="yellow" style="background: linear-gradient(135deg, #e8d5a3 0%, #d4c590 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">黄</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="red" style="background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">红</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="cyan" style="background: linear-gradient(135deg, #a5f3fc 0%, #67e8f9 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">青</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="gray" style="background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">灰</button>
                            <button class="panel-theme-preset" data-panel="${panelInfo.prefix}" data-theme="orange" style="background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%); width: 24px; height: 24px; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-size: 0.6rem; color: white;">橙</button>
                        </div>
                    </div>
                    
                    <!-- 详细颜色控制 -->
                    <div class="color-row">
                        <label>背景色</label>
                        <input type="color" id="${panelInfo.prefix}-panel-bg" value="#f8fafc" data-type="side" data-prefix="${panelInfo.prefix}" data-property="panel-bg">
                    </div>
                    <div class="color-row">
                        <label>边框色</label>
                        <input type="color" id="${panelInfo.prefix}-panel-border" value="#e2e8f0" data-type="side" data-prefix="${panelInfo.prefix}" data-property="panel-border">
                    </div>
                    <div class="color-row">
                        <label>标题色</label>
                        <input type="color" id="${panelInfo.prefix}-panel-title" value="#374151" data-type="side" data-prefix="${panelInfo.prefix}" data-property="panel-title">
                    </div>
                    <div class="color-row">
                        <label>块背景</label>
                        <input type="color" id="${panelInfo.prefix}-block-bg" value="#f1f5f9" data-type="side" data-prefix="${panelInfo.prefix}" data-property="block-bg">
                    </div>
                     <div class="color-row">
                        <label>块边框</label>
                        <input type="color" id="${panelInfo.prefix}-block-border" value="#cbd5e1" data-type="side" data-prefix="${panelInfo.prefix}" data-property="block-border">
                    </div>
                    <div class="color-row">
                        <label>块文字</label>
                        <input type="color" id="${panelInfo.prefix}-block-text" value="#475569" data-type="side" data-prefix="${panelInfo.prefix}" data-property="block-text">
                    </div>
                `;
            sidePanelColorControlsContainer.appendChild(controlDiv);
        }
    });

    // 添加事件监听器给颜色输入框
    const colorInputs = sidePanelColorControlsContainer.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        input.addEventListener('input', handleColorChange);
    });

    // 添加事件监听器给侧面板主题按钮
    const panelThemeButtons = sidePanelColorControlsContainer.querySelectorAll('.panel-theme-preset');
    panelThemeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const panelPrefix = e.target.dataset.panel;
            const themeName = e.target.dataset.theme;
            applyThemeToPanel(panelPrefix, themeName);
            
            // 更新按钮状态
            const panelButtons = sidePanelColorControlsContainer.querySelectorAll(`[data-panel="${panelPrefix}"]`);
            panelButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            saveColorSettings();
        });
    });
}


// 处理颜色变化
function handleColorChange(e) {
    const type = e.target.dataset.type;
    const color = e.target.value;

    if (type === 'layer') {
        const layerIndex = e.target.dataset.index;
        const property = e.target.dataset.property;
        updateLayerColor(layerIndex, property, color);
    } else if (type === 'side') {
        const prefix = e.target.dataset.prefix;
        const property = e.target.dataset.property;
        updateSidePanelColor(prefix, property, color);
    }
    saveColorSettings();
}

// 更新层级颜色
function updateLayerColor(layerIndex, property, color) {
    const root = document.documentElement;

    switch(property) {
        case 'bg':
            root.style.setProperty(`--layer-${layerIndex}-bg`, color);
            break;
        case 'border':
            root.style.setProperty(`--layer-${layerIndex}-border`, color);
            break;
        case 'title':
            root.style.setProperty(`--layer-${layerIndex}-title`, color);
            break;
        case 'service':
            const serviceColor = color;
            const darkerColor = adjustBrightness(serviceColor, -20);
            const textColor = adjustBrightness(serviceColor, -60); // Ensure good contrast
            const shadowColorRgba = hexToRgba(darkerColor, 0.2); // Shadow based on darker color for depth

            root.style.setProperty(`--layer-${layerIndex}-service-bg`, `linear-gradient(135deg, ${serviceColor} 0%, ${darkerColor} 100%)`);
            root.style.setProperty(`--layer-${layerIndex}-service-border`, darkerColor);
            root.style.setProperty(`--layer-${layerIndex}-service-text`, textColor);
            root.style.setProperty(`--layer-${layerIndex}-service-shadow`, `0 2px 8px ${shadowColorRgba}`);
            break;
    }
}

// 更新侧面板颜色
function updateSidePanelColor(prefix, property, color) {
    const root = document.documentElement;
    root.style.setProperty(`--${prefix}-${property}`, color);

    // Optional: Auto-derive related colors if a base color changes, e.g., block-bg
    if (property === 'block-bg') {
        // const baseColor = color;
        // const darkerBorder = adjustBrightness(baseColor, -15);
        // const contrastText = adjustBrightness(baseColor, -50); // Or determine if light/dark base and choose black/white
        // root.style.setProperty(`--${prefix}-block-border`, darkerBorder);
        // root.style.setProperty(`--${prefix}-block-text`, contrastText);
    }
    if (property === 'panel-bg') {
        // const baseColor = color;
        // const darkerBorder = adjustBrightness(baseColor, -10); // panel border slightly darker than bg
        // root.style.setProperty(`--${prefix}-panel-border`, darkerBorder);
    }
}


// 应用预设主题
function applyTheme(themeName) {
    const theme = themeColors[themeName];
    if (!theme) return;

    const layers = document.querySelectorAll('.architecture-layer');
    layers.forEach((layer, index) => {
        updateLayerFromTheme(index, theme);
        updateLayerColorInputs(index, theme); // Update pickers for layers
    });

    // For simplicity, side panels are not part of these themes directly.
    // They can be reset to a "default" or their specific initial colors.
    // Or, you could define side panel colors within each theme object too.
    // For now, let's assume they are reset/re-initialized by loadSettings or resetAllColors logic.

    document.querySelectorAll('.theme-preset').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`.theme-preset[data-theme="${themeName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    saveColorSettings();
}

// 应用主题到特定层级
function applyThemeToLayer(layerIndex, themeName) {
    const theme = themeColors[themeName];
    if (!theme) return;

    updateLayerFromTheme(layerIndex, theme);
    updateLayerColorInputs(layerIndex, theme);
    
    // 全局主题状态设为custom，因为现在是混合主题
    document.querySelectorAll('.theme-preset').forEach(btn => {
        btn.classList.remove('active');
    });
    
    saveColorSettings();
}

// 应用主题到特定侧面板
function applyThemeToPanel(panelPrefix, themeName) {
    const theme = themeColors[themeName];
    if (!theme) return;

    // 将层级主题映射到侧面板颜色
    const panelTheme = {
        'panel-bg': theme.layerBg,
        'panel-border': theme.border,
        'panel-title': theme.title,
        'block-bg': adjustBrightness(theme.layerBg, -3), // 稍微深一点的背景
        'block-border': theme.serviceBorder,
        'block-text': theme.serviceText
    };

    // 应用颜色到侧面板
    Object.keys(panelTheme).forEach(property => {
        updateSidePanelColor(panelPrefix, property, panelTheme[property]);
    });
    
    // 更新颜色选择器
    updateSidePanelColorInputs();
    
    // 全局主题状态设为custom，因为现在是混合主题
    document.querySelectorAll('.theme-preset').forEach(btn => {
        btn.classList.remove('active');
    });
    
    saveColorSettings();
}

// 从主题更新层级
function updateLayerFromTheme(layerIndex, theme) {
    const root = document.documentElement;
    root.style.setProperty(`--layer-${layerIndex}-bg`, theme.layerBg);
    root.style.setProperty(`--layer-${layerIndex}-border`, theme.border);
    root.style.setProperty(`--layer-${layerIndex}-title`, theme.title);
    root.style.setProperty(`--layer-${layerIndex}-service-bg`, theme.serviceBg);
    root.style.setProperty(`--layer-${layerIndex}-service-border`, theme.serviceBorder);
    root.style.setProperty(`--layer-${layerIndex}-service-text`, theme.serviceText);
    root.style.setProperty(`--layer-${layerIndex}-service-shadow`, theme.serviceShadow);
}

// 更新层级颜色选择器的值
function updateLayerColorInputs(layerIndex, themeColorsForLayer) {
    const bgInput = document.getElementById(`layer-${layerIndex}-bg`);
    const borderInput = document.getElementById(`layer-${layerIndex}-border`);
    const titleInput = document.getElementById(`layer-${layerIndex}-title`);
    const serviceInput = document.getElementById(`layer-${layerIndex}-service`); // This corresponds to the base color for service blocks

    if (bgInput) bgInput.value = themeColorsForLayer.layerBg;
    if (borderInput) borderInput.value = themeColorsForLayer.border;
    if (titleInput) titleInput.value = themeColorsForLayer.title;
    // For serviceInput, we used theme.serviceBorder as the 'base' for the picker in previous logic
    // If theme.serviceBg is a gradient, we need to pick a representative color.
    // Let's assume theme.serviceBorder is a good representative hex color.
    if (serviceInput) serviceInput.value = themeColorsForLayer.serviceBorder; // Or a base hex from which gradient is derived
}

// 更新侧面板颜色选择器的值
function updateSidePanelColorInputs() {
    const rootStyle = getComputedStyle(document.documentElement);
    const panelsInfo = [
        { prefix: 'left', enabled: currentState.leftPanelEnabled && leftPanelConfigured },
        { prefix: 'right', enabled: currentState.rightPanelEnabled && rightPanelConfigured }
    ];

    panelsInfo.forEach(panelInfo => {
        if (panelInfo.enabled) {
            const panelBGInput = document.getElementById(`${panelInfo.prefix}-panel-bg`);
            if (panelBGInput) panelBGInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-panel-bg`).trim() || '#f8fafc';

            const panelBorderInput = document.getElementById(`${panelInfo.prefix}-panel-border`);
            if (panelBorderInput) panelBorderInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-panel-border`).trim() || '#e2e8f0';

            const panelTitleInput = document.getElementById(`${panelInfo.prefix}-panel-title`);
            if (panelTitleInput) panelTitleInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-panel-title`).trim() || '#374151';

            const blockBGInput = document.getElementById(`${panelInfo.prefix}-block-bg`);
            if (blockBGInput) blockBGInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-block-bg`).trim() || '#f1f5f9';

            const blockBorderInput = document.getElementById(`${panelInfo.prefix}-block-border`);
            if (blockBorderInput) blockBorderInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-block-border`).trim() || '#cbd5e1';

            const blockTextInput = document.getElementById(`${panelInfo.prefix}-block-text`);
            if (blockTextInput) blockTextInput.value = rootStyle.getPropertyValue(`--${panelInfo.prefix}-block-text`).trim() || '#475569';
        }
    });
}


// 重置所有颜色
function resetAllColors() {
    // Apply a default theme (e.g., 'blue') for layers
    applyTheme('blue');

    // Reset side panel colors to their initial/default CSS variable values
    // These defaults should be defined in your main CSS or as initial JS variables
    const defaultSidePanelColors = {
        'panel-bg': '#f8fafc',
        'panel-border': '#e2e8f0',
        'panel-title': '#374151',
        'block-bg': '#f1f5f9',
        'block-border': '#cbd5e1',
        'block-text': '#475569',
    };

    ['left', 'right'].forEach(prefix => {
        if ((prefix === 'left' && currentState.leftPanelEnabled && leftPanelConfigured) ||
            (prefix === 'right' && currentState.rightPanelEnabled && rightPanelConfigured)) {
            for (const prop in defaultSidePanelColors) {
                updateSidePanelColor(prefix, prop, defaultSidePanelColors[prop]);
            }
        }
    });

    generateSidePanelColorControls(); // Regenerate to ensure they are present if panels were toggled
    updateSidePanelColorInputs(); // Update pickers to reflect these defaults
    saveColorSettings();
}


// 保存设置到localStorage
function saveColorSettings() {
    const settings = {
        width: currentState.containerWidth,
        scale: currentState.scale,
        leftPanelEnabled: currentState.leftPanelEnabled,
        rightPanelEnabled: currentState.rightPanelEnabled,
        connectionsVisible: currentState.connectionsVisible,
        leftPanelWidth: currentState.leftPanelWidth,
        rightPanelWidth: currentState.rightPanelWidth,
        colors: {
            layers: {},
            sidePanels: { left: {}, right: {} }
        },
        activeTheme: 'custom' // Default to custom, update if a theme is active
    };

    const layers = document.querySelectorAll('.architecture-layer');
    layers.forEach((layer, index) => {
        const bgInput = document.getElementById(`layer-${index}-bg`);
        const borderInput = document.getElementById(`layer-${index}-border`);
        const titleInput = document.getElementById(`layer-${index}-title`);
        const serviceInput = document.getElementById(`layer-${index}-service`);

        settings.colors.layers[index] = {
            bg: bgInput?.value || getComputedStyle(document.documentElement).getPropertyValue(`--layer-${index}-bg`).trim(),
            border: borderInput?.value || getComputedStyle(document.documentElement).getPropertyValue(`--layer-${index}-border`).trim(),
            title: titleInput?.value || getComputedStyle(document.documentElement).getPropertyValue(`--layer-${index}-title`).trim(),
            service: serviceInput?.value || adjustBrightness(getComputedStyle(document.documentElement).getPropertyValue(`--layer-${index}-service-border`).trim(), 20) // approximate base from border
        };
    });

    ['left', 'right'].forEach(prefix => {
        if ((prefix === 'left' && currentState.leftPanelEnabled && leftPanelConfigured) ||
            (prefix === 'right' && currentState.rightPanelEnabled && rightPanelConfigured)) {
            settings.colors.sidePanels[prefix] = {
                'panel-bg': document.getElementById(`${prefix}-panel-bg`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-panel-bg`).trim(),
                'panel-border': document.getElementById(`${prefix}-panel-border`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-panel-border`).trim(),
                'panel-title': document.getElementById(`${prefix}-panel-title`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-panel-title`).trim(),
                'block-bg': document.getElementById(`${prefix}-block-bg`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-block-bg`).trim(),
                'block-border': document.getElementById(`${prefix}-block-border`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-block-border`).trim(),
                'block-text': document.getElementById(`${prefix}-block-text`)?.value || getComputedStyle(document.documentElement).getPropertyValue(`--${prefix}-block-text`).trim(),
            };
        }
    });

    const activeThemeBtn = document.querySelector('.theme-preset.active');
    if (activeThemeBtn) {
        settings.activeTheme = activeThemeBtn.dataset.theme;
    }

    localStorage.setItem('three-column-architecture-settings', JSON.stringify(settings));
}


// 加载设置
function loadSettings() {
    const saved = localStorage.getItem('three-column-architecture-settings');
    if (!saved) {
        applyTheme('blue'); // Apply default theme if no settings saved
        // Set initial side panel colors from CSS variables (or defaults if not set)
        resetSidePanelColorsToDefaults();
        saveColorSettings(); // Save these initial defaults
        return;
    }

    try {
        const settings = JSON.parse(saved);

        // Layout settings
        currentState.containerWidth = settings.width || currentState.containerWidth;
        currentState.scale = settings.scale || currentState.scale;
        currentState.leftPanelEnabled = typeof settings.leftPanelEnabled === 'boolean' ? settings.leftPanelEnabled : currentState.leftPanelEnabled;
        currentState.rightPanelEnabled = typeof settings.rightPanelEnabled === 'boolean' ? settings.rightPanelEnabled : currentState.rightPanelEnabled;
        currentState.connectionsVisible = typeof settings.connectionsVisible === 'boolean' ? settings.connectionsVisible : currentState.connectionsVisible;
        currentState.leftPanelWidth = settings.leftPanelWidth || currentState.leftPanelWidth;
        currentState.rightPanelWidth = settings.rightPanelWidth || currentState.rightPanelWidth;

        const widthInput = document.getElementById('width-input');
        if (widthInput) widthInput.value = currentState.containerWidth;
        const scaleInput = document.getElementById('scale-input');
        if (scaleInput) scaleInput.value = currentState.scale;
        const leftWidthInput = document.getElementById('left-width-input');
        if (leftWidthInput) leftWidthInput.value = currentState.leftPanelWidth;
        const rightWidthInput = document.getElementById('right-width-input');
        if (rightWidthInput) rightWidthInput.value = currentState.rightPanelWidth;

        initializeEventListeners(); // Re-apply button states and panel visibility based on loaded currentState

        // Load layer colors
        if (settings.colors && settings.colors.layers) {
            Object.keys(settings.colors.layers).forEach(layerIndex => {
                const colors = settings.colors.layers[layerIndex];
                if (colors) {
                    updateLayerColor(layerIndex, 'bg', colors.bg);
                    updateLayerColor(layerIndex, 'border', colors.border);
                    updateLayerColor(layerIndex, 'title', colors.title);
                    updateLayerColor(layerIndex, 'service', colors.service); // This will derive service-bg, service-border etc.
                }
            });
        } else if (settings.activeTheme && settings.activeTheme !== 'custom' && themeColors[settings.activeTheme]) {
            applyTheme(settings.activeTheme); // Apply saved theme if no specific layer colors
        } else {
            applyTheme('blue'); // Fallback to default theme
        }

        // Load side panel colors
        if (settings.colors && settings.colors.sidePanels) {
            ['left', 'right'].forEach(prefix => {
                const panelColors = settings.colors.sidePanels[prefix];
                if (panelColors && Object.keys(panelColors).length > 0) { // Check if there are saved colors for this panel
                    if ((prefix === 'left' && currentState.leftPanelEnabled && leftPanelConfigured) ||
                        (prefix === 'right' && currentState.rightPanelEnabled && rightPanelConfigured)) {
                        Object.keys(panelColors).forEach(property => {
                            updateSidePanelColor(prefix, property, panelColors[property]);
                        });
                    }
                } else {
                    // If no saved colors for a panel, reset it to defaults
                    resetSidePanelColorsToDefaults(prefix);
                }
            });
        } else {
            resetSidePanelColorsToDefaults('left');
            resetSidePanelColorsToDefaults('right');
        }


        if (settings.activeTheme && settings.activeTheme !== 'custom') {
            const activeBtn = document.querySelector(`.theme-preset[data-theme="${settings.activeTheme}"]`);
            if (activeBtn) {
                document.querySelectorAll('.theme-preset').forEach(btn => btn.classList.remove('active'));
                activeBtn.classList.add('active');
            }
        } else {
            document.querySelectorAll('.theme-preset').forEach(btn => btn.classList.remove('active'));
        }

        applyResize(); // Apply width/scale
        updateGridLayout(); // Apply panel layout

    } catch (e) {
        console.error('Error loading saved settings:', e);
        applyTheme('blue');
        resetSidePanelColorsToDefaults();
    }
}

function resetSidePanelColorsToDefaults(specificPanelPrefix = null) {
    const defaultSidePanelColors = {
        'panel-bg': '#f8fafc', 'panel-border': '#e2e8f0', 'panel-title': '#374151',
        'block-bg': '#f1f5f9', 'block-border': '#cbd5e1', 'block-text': '#475569',
    };

    const prefixesToReset = specificPanelPrefix ? [specificPanelPrefix] : ['left', 'right'];

    prefixesToReset.forEach(prefix => {
        if ((prefix === 'left' && leftPanelConfigured) || (prefix === 'right' && rightPanelConfigured)) {
            for (const prop in defaultSidePanelColors) {
                updateSidePanelColor(prefix, prop, defaultSidePanelColors[prop]);
            }
        }
    });
}


// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
    // Initial generation of controls must happen before loadSettings if loadSettings might update their values
    generateLayerColorControls();
    generateSidePanelColorControls();

    loadSettings(); // Load settings first, this will set initial state and colors

    // Then update inputs to reflect loaded state
    updateLayerColorInputsAfterLoad();
    updateSidePanelColorInputs(); // Ensure side panel pickers are correct after load

    initializeEventListeners(); // Set up listeners and initial UI state based on possibly loaded settings
    updateGridLayout(); // Apply layout based on loaded panel states and widths
    applyResize(); // Apply loaded container width and scale

    document.querySelectorAll('.theme-preset').forEach(btn => {
        btn.addEventListener('click', () => {
            applyTheme(btn.dataset.theme);
            // After applying a theme, layer color inputs need to be updated
            updateLayerColorInputsAfterLoad();
            // Side panels are not part of themes in this setup, so their pickers remain as is or could be reset
        });
    });

    loadHtml2Canvas(); // Load the library for downloads
});

function updateLayerColorInputsAfterLoad() {
    const layers = document.querySelectorAll('.architecture-layer');
    layers.forEach((layer, index) => {
        const rootStyle = getComputedStyle(document.documentElement);
        const currentThemeForLayer = {
            layerBg: rootStyle.getPropertyValue(`--layer-${index}-bg`).trim(),
            border: rootStyle.getPropertyValue(`--layer-${index}-border`).trim(),
            title: rootStyle.getPropertyValue(`--layer-${index}-title`).trim(),
            // For service, picker expects a base color. We stored 'service' as the base color.
            // Or, we derive it from one of the resulting CSS variables, e.g., service-border
            serviceBorder: rootStyle.getPropertyValue(`--layer-${index}-service-border`).trim()
        };
        updateLayerColorInputs(index, currentThemeForLayer);
    });
}


// 下载功能实现
function downloadAsPNG() {
    alert('下载功能已被禁用');
}

function downloadAsJPEG() {
    alert('下载功能已被禁用');
}

function downloadAsImage(format) {
    if (typeof html2canvas === 'undefined') {
        alert('正在加载下载库，请稍后再试...');
        // Attempt to load it again if missed
        if (!document.querySelector('script[src*="html2canvas"]')) {
            loadHtml2Canvas();
        }
        return;
    }

    const container = document.getElementById('architecture-container');
    if (!container) {
        alert('无法找到截图区域!');
        return;
    }
    const originalTransform = container.style.transform;

    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '⏳ 生成中...';
    button.disabled = true;

    container.style.transform = 'none'; // Remove scaling for capture

    html2canvas(container, {
        backgroundColor: '#f8fafc', // Match body background or choose a specific one
        scale: window.devicePixelRatio * 2, // Higher scale for better quality
        useCORS: true,
        allowTaint: true, // May be needed for external images/fonts if any
        scrollX: -window.scrollX, // Capture from the top-left of the element
        scrollY: -window.scrollY,
        windowWidth: container.scrollWidth,
        windowHeight: container.scrollHeight,
        width: container.scrollWidth, // Explicitly set width
        height: container.scrollHeight, // Explicitly set height
        foreignObjectRendering: true // For SVG rendering
    }).then(canvas => {
        container.style.transform = originalTransform; // Restore transform

        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        link.download = `architecture-diagram-${timestamp}.${format}`;
        link.href = canvas.toDataURL(`image/${format}`, format === 'jpeg' ? 0.90 : 1.0); // Quality for JPEG

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        button.textContent = originalText;
        button.disabled = false;
    }).catch(error => {
        container.style.transform = originalTransform;
        button.textContent = originalText;
        button.disabled = false;
        alert('图片生成失败: ' + error.message);
        console.error('Download failed:', error);
    });
}

// 检查并加载html2canvas库
function loadHtml2Canvas() {
    console.log('下载功能已被禁用，跳过html2canvas库加载');
}

    
    // 初始化脚本
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化状态
        const leftPanelExists = true;
        const rightPanelExists = true;
        
        window.currentState = {
            leftPanelEnabled: leftPanelExists,
            rightPanelEnabled: rightPanelExists,
            connectionsVisible: true,
            leftPanelWidth: 200,
            rightPanelWidth: 200
        };
        
        window.leftPanelConfigured = leftPanelExists;
        window.rightPanelConfigured = rightPanelExists;
        
        // 初始化事件监听器
        if (typeof initializeEventListeners === 'function') {
            initializeEventListeners();
        }
        
        // 生成颜色控制
        if (typeof generateLayerColorControls === 'function') {
            generateLayerColorControls();
        }
        if (typeof generateSidePanelColorControls === 'function') {
            generateSidePanelColorControls();
        }
        
        // 加载设置
        if (typeof loadSettings === 'function') {
            loadSettings();
        }
        
        // 更新布局
        if (typeof updateGridLayout === 'function') {
            updateGridLayout();
        }
        
        // 应用初始大小设置
        if (typeof applyResize === 'function') {
            applyResize();
        }
    });

    // 修复的toggleConnections函数
    function toggleConnections() {
        const toggle = document.getElementById('connections-toggle');
        const svg = document.getElementById('connections-svg');
        const arrows = document.querySelectorAll('.arrow-up');
        const container = document.getElementById('architecture-container');

        currentState.connectionsVisible = !currentState.connectionsVisible;
        
        if (toggle) {
            toggle.textContent = currentState.connectionsVisible ? '隐藏' : '显示';
            toggle.classList.toggle('disabled', !currentState.connectionsVisible);
        }
        
        // 控制SVG连接线
        if (svg) {
            svg.style.display = currentState.connectionsVisible ? 'block' : 'none';
        }
        
        // 控制HTML箭头
        arrows.forEach(arrow => {
            arrow.style.display = currentState.connectionsVisible ? 'flex' : 'none';
        });
        
        // 通过CSS类控制整体布局紧凑性
        if (container) {
            if (currentState.connectionsVisible) {
                container.classList.remove('connections-hidden');
            } else {
                container.classList.add('connections-hidden');
            }
        }
        
        saveColorSettings();
    }
</script>

</body>
</html>